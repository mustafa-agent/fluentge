let r=[],c=null,l=0,v=0,a=0,i=0,u="all";const x="fluentge_conversations";function f(){try{return JSON.parse(localStorage.getItem(x)||"{}")}catch{return{}}}function B(e,t){const o=f();o[e]={score:t,date:new Date().toISOString()},localStorage.setItem(x,JSON.stringify(o))}function p(){const e=f(),t=Object.values(e);if(document.getElementById("completed-count").textContent=t.length,t.length>0){const n=Math.round(t.reduce((s,d)=>s+d.score,0)/t.length);document.getElementById("average-score").textContent=n+"%"}const o=r.filter(n=>e[n.id]).sort((n,s)=>n.id-s.id);for(let n=o.length-1;n>=0&&e[o[n].id];n--);document.getElementById("streak-count").textContent=t.length}function h(){const e=document.getElementById("conversation-list"),t=f(),o=u==="all"?r:r.filter(n=>n.level===u);e.innerHTML=o.map(n=>{const s=t[n.id],d=s?`${s.score}%`:"";return`
          <div class="conv-card ${s?"completed":""}" data-id="${n.id}">
            <span class="checkmark">âœ…</span>
            <div class="text-2xl mb-2">${n.icon}</div>
            <div class="flex items-center gap-2 mb-1">
              <span class="text-xs px-2 py-0.5 rounded-full bg-[#2E2E30] text-[#6B6B65]">${n.level}</span>
              ${s?`<span class="text-xs text-green-400">${d}</span>`:""}
            </div>
            <h3 class="font-medium text-sm">${n.title}</h3>
            <p class="text-xs text-[#6B6B65]">${n.titleGe}</p>
          </div>
        `}).join(""),e.querySelectorAll(".conv-card").forEach(n=>{n.addEventListener("click",()=>E(parseInt(n.dataset.id)))})}function E(e){c=r.find(t=>t.id===e),c&&(l=0,a=0,i=c.turns.filter(t=>t.speaker==="user").length,v=0,document.getElementById("conversation-list").classList.add("hidden"),document.getElementById("conversation-player").classList.remove("hidden"),document.getElementById("conv-level").textContent=c.level,document.getElementById("conv-title").textContent=`${c.icon} ${c.title}`,document.getElementById("conv-title-small").textContent=c.titleGe,document.getElementById("chat-area").innerHTML="",document.getElementById("score-screen").classList.add("hidden"),document.getElementById("options-area").classList.remove("hidden"),document.getElementById("feedback-area").classList.add("hidden"),m())}function m(){if(l>=c.turns.length){b();return}const e=c.turns[l],t=`áƒœáƒáƒ‘áƒ˜áƒ¯áƒ˜ ${v+1} / ${i}`;document.getElementById("conv-progress").textContent=t,e.speaker==="other"?(g(e.text,e.textGe,"other"),l++,setTimeout(()=>m(),600)):I(e.options)}function g(e,t,o){const n=document.getElementById("chat-area"),s=document.createElement("div");s.className=`chat-bubble ${o}`,s.innerHTML=`<div>${e}</div><div class="ge-text">${t}</div>`,n.appendChild(s),n.scrollTop=n.scrollHeight}function I(e){const t=document.getElementById("options-area");t.innerHTML=e.map((o,n)=>`
        <button class="option-btn" data-index="${n}">
          <div>${o.text}</div>
          <div class="ge-hint">${o.textGe}</div>
        </button>
      `).join(""),t.querySelectorAll(".option-btn").forEach(o=>{o.addEventListener("click",()=>L(parseInt(o.dataset.index),e))})}function L(e,t){const o=t[e],n=document.querySelectorAll(".option-btn");if(n.forEach(s=>s.style.pointerEvents="none"),t.forEach((s,d)=>{s.correct&&n[d].classList.add("correct"),d===e&&!s.correct&&n[d].classList.add("wrong")}),v++,o.correct)a++,g(o.text,o.textGe,"user"),document.getElementById("feedback-area").classList.add("hidden"),l++,setTimeout(()=>{document.getElementById("options-area").innerHTML="",m()},800);else{const s=document.getElementById("feedback-area");s.className="mt-4 p-4 rounded-xl bg-[rgba(244,67,54,0.1)] border border-[rgba(244,67,54,0.3)]",s.innerHTML=`
          <p class="text-sm text-red-300 mb-1">âŒ áƒáƒ áƒáƒ¡áƒ¬áƒáƒ áƒ˜áƒ</p>
          <p class="text-sm text-[#6B6B65]">${o.hint||"áƒ”áƒªáƒáƒ“áƒ” áƒ¡áƒ®áƒ•áƒ áƒ•áƒáƒ áƒ˜áƒáƒœáƒ¢áƒ˜."}</p>
        `,s.classList.remove("hidden");const d=t.find(y=>y.correct);g(d.text,d.textGe,"user"),l++,setTimeout(()=>{s.classList.add("hidden"),document.getElementById("options-area").innerHTML="",m()},1500)}}function b(){const e=Math.round(a/i*100);document.getElementById("options-area").classList.add("hidden"),document.getElementById("score-screen").classList.remove("hidden"),document.getElementById("final-score").textContent=e+"%",document.getElementById("correct-count").textContent=`${a}/${i}`;let t="";e===100?t="ğŸŒŸ áƒ¡áƒ áƒ£áƒšáƒ§áƒáƒ¤áƒ˜áƒšáƒ˜! áƒ¨áƒ”áƒ¡áƒáƒœáƒ˜áƒ¨áƒœáƒáƒ•áƒ˜ áƒ¡áƒáƒ£áƒ‘áƒáƒ áƒ˜!":e>=75?t="ğŸ‘ áƒ«áƒáƒšáƒ˜áƒáƒœ áƒ™áƒáƒ áƒ’áƒ˜! áƒ—áƒ˜áƒ—áƒ¥áƒ›áƒ˜áƒ¡ áƒ¡áƒ áƒ£áƒšáƒ§áƒáƒ¤áƒ˜áƒšáƒ˜!":e>=50?t="ğŸ‘ áƒ™áƒáƒ áƒ’áƒ˜! áƒªáƒáƒ¢áƒ áƒ›áƒ”áƒ¢áƒ˜ áƒáƒ áƒáƒ¥áƒ¢áƒ˜áƒ™áƒ áƒ“áƒáƒ’áƒ”áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ.":t="ğŸ’ª áƒ’áƒáƒáƒ’áƒ áƒ«áƒ”áƒšáƒ” áƒ•áƒáƒ áƒ¯áƒ˜áƒ¨áƒ˜! áƒáƒ áƒáƒ¥áƒ¢áƒ˜áƒ™áƒ áƒ¡áƒ áƒ£áƒšáƒ§áƒáƒ¤áƒ˜áƒšáƒ”áƒ‘áƒáƒ¡ áƒ¥áƒ›áƒœáƒ˜áƒ¡.",document.getElementById("score-text").textContent=t,B(c.id,e),p()}document.getElementById("back-to-list").addEventListener("click",()=>{document.getElementById("conversation-player").classList.add("hidden"),document.getElementById("conversation-list").classList.remove("hidden"),h()});document.getElementById("retry-btn").addEventListener("click",()=>{E(c.id)});document.getElementById("next-conv-btn").addEventListener("click",()=>{const e=r.findIndex(o=>o.id===c.id),t=r[(e+1)%r.length];E(t.id)});document.querySelectorAll(".level-filter").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".level-filter").forEach(t=>t.classList.remove("active")),e.classList.add("active"),u=e.dataset.level,h()})});fetch("/data/conversations.json").then(e=>e.json()).then(e=>{r=e,h(),p()});
