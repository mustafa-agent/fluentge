---
import Layout from '../layouts/Layout.astro';
---

<Layout title="შესვლა — FluentGe">
  <div class="min-h-[80vh] flex items-center justify-center px-4 py-12">
    <div class="w-full max-w-md">
      
      <div class="text-center mb-8">
        <h1 class="font-['Playfair_Display',serif] text-3xl mb-2">
          <span class="text-[#C8C8C0]">Fluent</span>Ge
        </h1>
      </div>

      <!-- Tab switcher -->
      <div class="flex mb-6 bg-[#242426] rounded-xl p-1 border border-[#2E2E30]">
        <button id="tab-login" onclick="switchTab('login')" class="flex-1 py-2.5 rounded-lg text-sm font-semibold transition-colors bg-[#2E2E30] text-white">შესვლა</button>
        <button id="tab-register" onclick="switchTab('register')" class="flex-1 py-2.5 rounded-lg text-sm font-semibold transition-colors text-[#6B6B65]">რეგისტრაცია</button>
      </div>

      <!-- LOGIN FORM -->
      <div id="form-login">
        <div class="space-y-4 mb-4">
          <div>
            <label class="text-xs text-[#6B6B65] mb-1 block">ელ-ფოსტა</label>
            <input id="login-email" type="email" placeholder="email@example.com" 
              class="w-full bg-[#242426] border border-[#2E2E30] rounded-xl px-4 py-3 text-sm focus:border-[#C8C8C0] focus:outline-none transition-colors placeholder-[#6B6B65]">
          </div>
          <div>
            <label class="text-xs text-[#6B6B65] mb-1 block">პაროლი</label>
            <input id="login-password" type="password" placeholder="••••••••" 
              class="w-full bg-[#242426] border border-[#2E2E30] rounded-xl px-4 py-3 text-sm focus:border-[#C8C8C0] focus:outline-none transition-colors placeholder-[#6B6B65]">
          </div>
        </div>
        <button id="login-btn" onclick="handleLogin()" class="w-full bg-[#C8C8C0] text-[#1C1C1E] font-semibold py-3.5 rounded-xl text-sm hover:bg-[#E8E8E0] transition-colors">
          შესვლა
        </button>
        <div class="mt-2 text-right">
          <button onclick="handleReset()" class="text-xs text-[#6B6B65] hover:text-[#C8C8C0] transition-colors">დაგავიწყდა პაროლი?</button>
        </div>
      </div>

      <!-- REGISTER FORM -->
      <div id="form-register" class="hidden">
        <div class="space-y-4 mb-4">
          <div>
            <label class="text-xs text-[#6B6B65] mb-1 block">სახელი</label>
            <input id="reg-name" type="text" placeholder="თქვენი სახელი" 
              class="w-full bg-[#242426] border border-[#2E2E30] rounded-xl px-4 py-3 text-sm focus:border-[#C8C8C0] focus:outline-none transition-colors placeholder-[#6B6B65]">
          </div>
          <div>
            <label class="text-xs text-[#6B6B65] mb-1 block">ელ-ფოსტა</label>
            <input id="reg-email" type="email" placeholder="email@example.com" 
              class="w-full bg-[#242426] border border-[#2E2E30] rounded-xl px-4 py-3 text-sm focus:border-[#C8C8C0] focus:outline-none transition-colors placeholder-[#6B6B65]">
          </div>
          <div>
            <label class="text-xs text-[#6B6B65] mb-1 block">პაროლი</label>
            <input id="reg-password" type="password" placeholder="მინიმუმ 6 სიმბოლო" 
              class="w-full bg-[#242426] border border-[#2E2E30] rounded-xl px-4 py-3 text-sm focus:border-[#C8C8C0] focus:outline-none transition-colors placeholder-[#6B6B65]">
          </div>
          <div>
            <label class="text-xs text-[#6B6B65] mb-1 block">გაიმეორე პაროლი</label>
            <input id="reg-password2" type="password" placeholder="••••••••" 
              class="w-full bg-[#242426] border border-[#2E2E30] rounded-xl px-4 py-3 text-sm focus:border-[#C8C8C0] focus:outline-none transition-colors placeholder-[#6B6B65]">
          </div>
        </div>
        <button id="reg-btn" onclick="handleRegister()" class="w-full bg-[#C8C8C0] text-[#1C1C1E] font-semibold py-3.5 rounded-xl text-sm hover:bg-[#E8E8E0] transition-colors">
          რეგისტრაცია
        </button>
      </div>

      <!-- Divider -->
      <div class="flex items-center gap-3 my-6">
        <div class="flex-1 h-px bg-[#2E2E30]"></div>
        <span class="text-xs text-[#6B6B65]">ან</span>
        <div class="flex-1 h-px bg-[#2E2E30]"></div>
      </div>

      <!-- Google Sign In -->
      <button id="google-btn" onclick="handleGoogle()" class="w-full bg-[#242426] hover:bg-[#2E2E30] border border-[#2E2E30] font-semibold py-3.5 rounded-xl text-sm transition-colors flex items-center justify-center gap-3">
        <svg width="20" height="20" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
        Google-ით შესვლა
      </button>

      <!-- Message -->
      <div id="auth-message" class="mt-4 text-center text-sm hidden"></div>

      <div class="mt-6 text-center">
        <p class="text-[#6B6B65] text-xs">შესვლით ეთანხმები ჩვენს <a href="/about/" class="underline">პირობებს</a></p>
      </div>

    </div>
  </div>

  <script is:inline type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getAuth, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, sendPasswordResetEmail, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

    const app = initializeApp({
      apiKey: "AIzaSyBYJ6xzlp6tP7oIQoz9UzfYbjrVgR3JrwQ",
      authDomain: "fluentge.firebaseapp.com",
      projectId: "fluentge",
      storageBucket: "fluentge.firebasestorage.app",
      messagingSenderId: "140225085227",
      appId: "1:140225085227:web:d10b8efd8c08a131574f6e"
    });
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    const PREMIUM_EMAILS = ['tokakhozre@gmail.com'];

    function saveUser(user) {
      localStorage.setItem('fluentge-user', JSON.stringify({
        email: user.email,
        name: user.displayName,
        photo: user.photoURL,
        uid: user.uid
      }));
      if (PREMIUM_EMAILS.includes(user.email)) {
        localStorage.setItem('fluentge-premium', 'true');
      }
    }

    function showMsg(text, ok) {
      const msg = document.getElementById('auth-message');
      msg.textContent = text;
      msg.className = 'mt-4 text-center text-sm ' + (ok ? 'text-green-400' : 'text-red-400');
    }

    function errMsg(code) {
      const map = {
        'auth/email-already-in-use': 'ეს ელ-ფოსტა უკვე რეგისტრირებულია',
        'auth/invalid-email': 'არასწორი ელ-ფოსტა',
        'auth/weak-password': 'პაროლი ძალიან მოკლეა (მინ. 6)',
        'auth/user-not-found': 'მომხმარებელი ვერ მოიძებნა',
        'auth/wrong-password': 'არასწორი პაროლი',
        'auth/invalid-credential': 'არასწორი ელ-ფოსტა ან პაროლი',
        'auth/too-many-requests': 'ძალიან ბევრი მცდელობა. სცადე მოგვიანებით',
        'auth/popup-closed-by-user': 'ფანჯარა დაიხურა',
      };
      return map[code] || 'შეცდომა. სცადე თავიდან';
    }

    // If already signed in, go to account
    onAuthStateChanged(auth, (user) => {
      if (user) {
        saveUser(user);
        window.location.href = '/account/';
      }
    });

    // Tab switching
    window.switchTab = function(tab) {
      document.getElementById('form-login').classList.toggle('hidden', tab !== 'login');
      document.getElementById('form-register').classList.toggle('hidden', tab !== 'register');
      document.getElementById('tab-login').className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold transition-colors ' + (tab === 'login' ? 'bg-[#2E2E30] text-white' : 'text-[#6B6B65]');
      document.getElementById('tab-register').className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold transition-colors ' + (tab === 'register' ? 'bg-[#2E2E30] text-white' : 'text-[#6B6B65]');
      document.getElementById('auth-message').className = 'mt-4 text-center text-sm hidden';
    };

    // Email login
    window.handleLogin = async function() {
      const email = document.getElementById('login-email').value.trim();
      const pass = document.getElementById('login-password').value;
      if (!email || !pass) return showMsg('შეავსე ყველა ველი', false);
      
      try {
        const result = await signInWithEmailAndPassword(auth, email, pass);
        saveUser(result.user);
        showMsg('წარმატებით შეხვედი! ✅', true);
        setTimeout(() => window.location.href = '/account/', 1000);
      } catch (e) {
        showMsg(errMsg(e.code), false);
      }
    };

    // Email register
    window.handleRegister = async function() {
      const name = document.getElementById('reg-name').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const pass = document.getElementById('reg-password').value;
      const pass2 = document.getElementById('reg-password2').value;
      
      if (!name || !email || !pass) return showMsg('შეავსე ყველა ველი', false);
      if (pass !== pass2) return showMsg('პაროლები არ ემთხვევა', false);
      if (pass.length < 6) return showMsg('პაროლი მინიმუმ 6 სიმბოლო', false);
      
      try {
        const result = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(result.user, { displayName: name });
        saveUser({ ...result.user, displayName: name });
        showMsg('ანგარიში შეიქმნა! ✅', true);
        setTimeout(() => window.location.href = '/account/', 1000);
      } catch (e) {
        showMsg(errMsg(e.code), false);
      }
    };

    // Google
    window.handleGoogle = async function() {
      try {
        const result = await signInWithPopup(auth, googleProvider);
        saveUser(result.user);
        showMsg('წარმატებით შეხვედი! ✅', true);
        setTimeout(() => window.location.href = '/account/', 1000);
      } catch (e) {
        if (e.code !== 'auth/popup-closed-by-user') showMsg(errMsg(e.code), false);
      }
    };

    // Password reset
    window.handleReset = async function() {
      const email = document.getElementById('login-email').value.trim();
      if (!email) return showMsg('ჯერ ჩაწერე ელ-ფოსტა', false);
      try {
        await sendPasswordResetEmail(auth, email);
        showMsg('პაროლის აღდგენის ლინკი გამოგზავნილია ✅', true);
      } catch (e) {
        showMsg(errMsg(e.code), false);
      }
    };

    // Enter key submit
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        if (!document.getElementById('form-login').classList.contains('hidden')) handleLogin();
        else handleRegister();
      }
    });
  </script>
</Layout>
