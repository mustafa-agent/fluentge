---
import Layout from '../../layouts/Layout.astro';
import fs from 'node:fs';
import path from 'node:path';

export function getStaticPaths() {
  const grammarDir = path.resolve('..', 'content', 'grammar');
  const files = fs.readdirSync(grammarDir).filter(f => f.endsWith('.json'));
  return files.map(f => {
    const lesson = JSON.parse(fs.readFileSync(path.join(grammarDir, f), 'utf-8'));
    return { params: { slug: lesson.slug }, props: { lesson } };
  });
}

const { lesson } = Astro.props;
const FREE_GRAMMAR_SLUGS = ['to-be', 'articles', 'plural-nouns'];
const isFree = FREE_GRAMMAR_SLUGS.includes(lesson.slug);
---

<Layout title={`${lesson.title_ka} â€” FluentGe`}>
  <section class="max-w-3xl mx-auto px-4 py-16">
    <!-- Header -->
    <a href="/grammar/" class="text-[#22c55e] hover:underline text-sm mb-6 inline-block">â† áƒ’áƒ áƒáƒ›áƒáƒ¢áƒ˜áƒ™áƒ</a>
    <div class="flex items-center gap-3 mb-2">
      <span class={`px-3 py-1 rounded-full text-xs font-bold ${lesson.level === 'A1' ? 'bg-green-500/20 text-green-400' : 'bg-blue-500/20 text-blue-400'}`}>{lesson.level}</span>
      <span class="text-[#94a3b8] text-sm">áƒ’áƒáƒ™áƒ•áƒ”áƒ—áƒ˜áƒšáƒ˜ #{lesson.id}</span>
    </div>
    <h1 class="text-3xl font-bold mb-1">{lesson.title_ka}</h1>
    <p class="text-[#94a3b8] mb-8">{lesson.title_en}</p>

    {isFree ? (
    <>
    <!-- Explanation -->
    <div class="bg-white/5 border border-white/10 rounded-xl p-6 mb-8">
      <h2 class="text-xl font-bold mb-4">ğŸ“š áƒáƒ®áƒ¡áƒœáƒ</h2>
      <div class="text-[#cbd5e1] leading-relaxed whitespace-pre-line">{lesson.explanation_ka}</div>
    </div>

    <!-- Examples -->
    <div class="bg-white/5 border border-white/10 rounded-xl p-6 mb-8">
      <h2 class="text-xl font-bold mb-4">ğŸ’¡ áƒ›áƒáƒ’áƒáƒšáƒ˜áƒ—áƒ”áƒ‘áƒ˜</h2>
      <div class="space-y-3">
        {lesson.examples.map((ex: {en: string, ka: string}) => (
          <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-4 py-2 border-b border-white/5 last:border-0">
            <span class="font-medium text-[#22c55e]">{ex.en}</span>
            <span class="text-[#94a3b8]">â€” {ex.ka}</span>
          </div>
        ))}
      </div>
    </div>

    <!-- Common Mistakes -->
    <div class="bg-red-500/5 border border-red-500/20 rounded-xl p-6 mb-8">
      <h2 class="text-xl font-bold mb-4 text-red-400">âš ï¸ áƒ®áƒ¨áƒ˜áƒ áƒ˜ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ”áƒ‘áƒ˜</h2>
      <p class="text-[#cbd5e1] leading-relaxed whitespace-pre-line">{lesson.common_mistakes_ka}</p>
    </div>

    <!-- Exercises -->
    <div class="bg-white/5 border border-white/10 rounded-xl p-6" id="exercises-section">
      <h2 class="text-xl font-bold mb-6">âœï¸ áƒ¡áƒáƒ•áƒáƒ áƒ¯áƒ˜áƒ¨áƒáƒ”áƒ‘áƒ˜</h2>
      <div id="exercise-container"></div>
      <div id="score-container" class="hidden mt-6 text-center">
        <div class="text-4xl font-bold mb-2" id="score-text"></div>
        <p class="text-[#94a3b8] mb-4" id="score-msg"></p>
        <button id="retry-btn" class="bg-[#22c55e] hover:bg-[#16a34a] text-white px-6 py-2 rounded-lg font-semibold transition-colors">áƒ—áƒáƒ•áƒ˜áƒ“áƒáƒœ áƒªáƒ“áƒ</button>
      </div>
    </div>
    </>
    ) : (
    <!-- Premium locked -->
    <div class="mt-8 text-center">
      <div class="bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/20 rounded-2xl p-12">
        <div class="text-6xl mb-4">ğŸ”’</div>
        <h2 class="text-2xl font-bold mb-3">áƒ”áƒ¡ áƒ’áƒáƒ™áƒ•áƒ”áƒ—áƒ˜áƒšáƒ˜ áƒáƒ áƒ”áƒ›áƒ˜áƒ£áƒ›áƒ˜áƒ</h2>
        <p class="text-[#94a3b8] mb-6 max-w-md mx-auto">áƒ’áƒáƒ®áƒ¡áƒ”áƒœáƒ˜ áƒ§áƒ•áƒ”áƒšáƒ 30 áƒ’áƒ áƒáƒ›áƒáƒ¢áƒ˜áƒ™áƒ˜áƒ¡ áƒ’áƒáƒ™áƒ•áƒ”áƒ—áƒ˜áƒšáƒ˜, 1060+ áƒ¡áƒ˜áƒ¢áƒ§áƒ•áƒ áƒ“áƒ áƒ§áƒ•áƒ”áƒšáƒ áƒ™áƒáƒ¢áƒ”áƒ’áƒáƒ áƒ˜áƒ áƒáƒ áƒ”áƒ›áƒ˜áƒ£áƒ› áƒ’áƒ”áƒ’áƒ›áƒ˜áƒ—.</p>
        <a href="/register/" class="inline-block bg-[var(--color-primary)] hover:bg-[var(--color-primary-hover)] text-white font-bold py-3 px-8 rounded-xl text-lg transition-colors">
          ğŸš€ áƒ“áƒáƒ˜áƒ¬áƒ§áƒ” áƒáƒ áƒ”áƒ›áƒ˜áƒ£áƒ›áƒ˜
        </a>
        <p class="text-[#64748b] text-sm mt-4">áƒ—áƒ•áƒ”áƒ¨áƒ˜ áƒ›áƒ®áƒáƒšáƒáƒ“ 9.99 áƒšáƒáƒ áƒ˜</p>
      </div>
    </div>
    )}
  </section>

  <script define:vars={{ exercises: lesson.exercises, isFree }}>
    // Sound feedback â€” resume AudioContext on first user click (required by browsers)
    let audioCtx = null;
    function getCtx() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume();
      return audioCtx;
    }
    function playCorrectSound() {
      try {
        const ctx = getCtx();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g);
        g.connect(ctx.destination);
        g.gain.setValueAtTime(0.15, ctx.currentTime);
        o.type = 'sine';
        o.frequency.setValueAtTime(523, ctx.currentTime);
        o.frequency.setValueAtTime(659, ctx.currentTime + 0.1);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
        o.start(ctx.currentTime);
        o.stop(ctx.currentTime + 0.35);
      } catch(e) { console.log('sound error', e); }
    }
    function playWrongSound() {
      try {
        const ctx = getCtx();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g);
        g.connect(ctx.destination);
        g.gain.setValueAtTime(0.12, ctx.currentTime);
        o.type = 'sine';
        o.frequency.setValueAtTime(330, ctx.currentTime);
        o.frequency.setValueAtTime(262, ctx.currentTime + 0.15);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25);
        o.start(ctx.currentTime);
        o.stop(ctx.currentTime + 0.3);
      } catch(e) { console.log('sound error', e); }
    }

    if (!isFree) { /* skip exercises for premium lessons */ }
    else {
    let current = 0;
    let score = 0;
    let answered = false;

    const container = document.getElementById('exercise-container');
    const scoreContainer = document.getElementById('score-container');

    function render() {
      if (current >= exercises.length) {
        container.classList.add('hidden');
        scoreContainer.classList.remove('hidden');
        const pct = Math.round((score / exercises.length) * 100);
        document.getElementById('score-text').textContent = `${score}/${exercises.length} (${pct}%)`;
        document.getElementById('score-msg').textContent = pct >= 80 ? 'ğŸ‰ áƒ¨áƒ”áƒ¡áƒáƒœáƒ˜áƒ¨áƒœáƒáƒ•áƒ˜!' : pct >= 50 ? 'ğŸ‘ áƒ™áƒáƒ áƒ’áƒ˜ áƒ¨áƒ”áƒ“áƒ”áƒ’áƒ˜!' : 'ğŸ’ª áƒ™áƒ˜áƒ“áƒ”áƒ• áƒ¡áƒªáƒáƒ“áƒ”!';
        return;
      }
      answered = false;
      const ex = exercises[current];
      const isMulti = ex.type === 'multiple-choice';
      
      let html = `<div class="mb-3 text-xs text-[#64748b]">${current + 1}/${exercises.length}</div>`;
      html += `<div class="w-full bg-white/10 rounded-full h-1.5 mb-6"><div class="bg-[#22c55e] h-1.5 rounded-full transition-all" style="width:${((current) / exercises.length) * 100}%"></div></div>`;
      
      if (isMulti) {
        html += `<p class="text-lg font-medium mb-4">${ex.question}</p>`;
      } else {
        html += `<p class="text-lg font-medium mb-4">${ex.question.replace('___', '<span class="text-[#22c55e] font-bold">______</span>')}</p>`;
      }
      
      html += `<div class="grid gap-3">`;
      for (const opt of ex.options) {
        html += `<button class="opt-btn text-left px-4 py-3 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition-colors font-medium" data-val="${opt}">${opt}</button>`;
      }
      html += `</div><div id="feedback" class="mt-4"></div>`;
      
      container.innerHTML = html;
      container.querySelectorAll('.opt-btn').forEach(btn => {
        btn.addEventListener('click', () => handleAnswer(btn));
      });
    }

    function handleAnswer(btn) {
      if (answered) return;
      answered = true;
      const val = btn.dataset.val;
      const ex = exercises[current];
      const correct = val === ex.answer;
      if (correct) { score++; playCorrectSound(); } else { playWrongSound(); }

      container.querySelectorAll('.opt-btn').forEach(b => {
        if (b.dataset.val === ex.answer) {
          b.classList.remove('bg-white/5', 'border-white/10');
          b.classList.add('bg-green-500/20', 'border-green-500', 'text-green-400');
        } else if (b === btn && !correct) {
          b.classList.remove('bg-white/5', 'border-white/10');
          b.classList.add('bg-red-500/20', 'border-red-500', 'text-red-400');
        }
        b.classList.add('pointer-events-none');
      });

      document.getElementById('feedback').innerHTML = correct
        ? '<p class="text-green-400 font-medium">âœ… áƒ¡áƒ¬áƒáƒ áƒ˜áƒ!</p>'
        : `<p class="text-red-400 font-medium">âŒ áƒáƒ áƒáƒ¡áƒ¬áƒáƒ áƒ˜áƒ. áƒ¡áƒ¬áƒáƒ áƒ˜ áƒáƒáƒ¡áƒ£áƒ®áƒ˜: <strong>${ex.answer}</strong></p>`;

      setTimeout(() => { current++; render(); }, 1500);
    }

    document.getElementById('retry-btn').addEventListener('click', () => {
      current = 0; score = 0;
      scoreContainer.classList.add('hidden');
      container.classList.remove('hidden');
      render();
    });

    render();
    }
  </script>
</Layout>
