---
import Layout from '../../layouts/Layout.astro';
import fs from 'node:fs';
import path from 'node:path';

export function getStaticPaths() {
  const grammarDir = path.resolve('..', 'content', 'grammar');
  const files = fs.readdirSync(grammarDir).filter(f => f.endsWith('.json'));
  return files.map(f => {
    const lesson = JSON.parse(fs.readFileSync(path.join(grammarDir, f), 'utf-8'));
    return { params: { slug: lesson.slug }, props: { lesson } };
  });
}

const { lesson } = Astro.props;
const FREE_GRAMMAR_SLUGS = ['to-be', 'articles', 'plural-nouns'];
const isFree = FREE_GRAMMAR_SLUGS.includes(lesson.slug);
---

<Layout title={`${lesson.title_ka} â€” FluentGe`}>
  <section class="max-w-3xl mx-auto px-4 py-16">
    <!-- Header -->
    <a href="/grammar/" class="text-[#C8C8C0] hover:underline text-sm mb-6 inline-block">â† áƒ’áƒ áƒáƒ›áƒáƒ¢áƒ˜áƒ™áƒ</a>
    <div class="flex items-center gap-3 mb-2">
      <span class={`px-3 py-1 rounded-full text-xs font-bold ${lesson.level === 'A1' ? 'bg-green-500/20 text-green-400' : lesson.level === 'A2' ? 'bg-blue-500/20 text-blue-400' : lesson.level === 'B1' ? 'bg-yellow-500/20 text-yellow-400' : lesson.level === 'B2' ? 'bg-orange-500/20 text-orange-400' : 'bg-purple-500/20 text-purple-400'}`}>{lesson.level}</span>
      <span class="text-[#6B6B65] text-sm">áƒ’áƒáƒ™áƒ•áƒ”áƒ—áƒ˜áƒšáƒ˜ #{lesson.id}</span>
    </div>
    <h1 class="text-3xl font-bold mb-1">{lesson.title_ka}</h1>
    <p class="text-[#6B6B65] mb-8">{lesson.title_en}</p>

    <!-- Lesson Content (hidden for non-premium if lesson is premium) -->
    <div id="lesson-content" class={isFree ? '' : 'hidden'}>
    <!-- Explanation -->
    <div class="bg-[#242426] border border-[#2E2E30] rounded-xl p-6 mb-8">
      <h2 class="text-xl font-bold mb-4">ğŸ“š áƒáƒ®áƒ¡áƒœáƒ</h2>
      <div class="text-[#cbd5e1] leading-relaxed whitespace-pre-line">{lesson.explanation_ka}</div>
    </div>

    <!-- Examples -->
    <div class="bg-[#242426] border border-[#2E2E30] rounded-xl p-6 mb-8">
      <h2 class="text-xl font-bold mb-4">ğŸ’¡ áƒ›áƒáƒ’áƒáƒšáƒ˜áƒ—áƒ”áƒ‘áƒ˜</h2>
      <div class="space-y-3">
        {lesson.examples.map((ex: {en: string, ka: string}) => (
          <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-4 py-2 border-b border-white/5 last:border-0">
            <span class="font-medium text-[#C8C8C0]">{ex.en}</span>
            <span class="text-[#6B6B65]">â€” {ex.ka}</span>
          </div>
        ))}
      </div>
    </div>

    <!-- Common Mistakes -->
    <div class="bg-red-500/5 border border-red-500/20 rounded-xl p-6 mb-8">
      <h2 class="text-xl font-bold mb-4 text-red-400">âš ï¸ áƒ®áƒ¨áƒ˜áƒ áƒ˜ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ”áƒ‘áƒ˜</h2>
      <p class="text-[#cbd5e1] leading-relaxed whitespace-pre-line">{lesson.common_mistakes_ka}</p>
    </div>

    <!-- Exercises -->
    <div class="bg-[#242426] border border-[#2E2E30] rounded-xl p-6" id="exercises-section">
      <h2 class="text-xl font-bold mb-6">âœï¸ áƒ¡áƒáƒ•áƒáƒ áƒ¯áƒ˜áƒ¨áƒáƒ”áƒ‘áƒ˜</h2>
      <div id="exercise-container"></div>
      <div id="score-container" class="hidden mt-6 text-center">
        <div class="text-4xl font-bold mb-2" id="score-text"></div>
        <p class="text-[#6B6B65] mb-4" id="score-msg"></p>
        <button id="retry-btn" class="bg-[#C8C8C0] hover:bg-[#A0A09A] text-white px-6 py-2 rounded-lg font-semibold transition-colors">áƒ—áƒáƒ•áƒ˜áƒ“áƒáƒœ áƒªáƒ“áƒ</button>
      </div>
    </div>
    </div>

    <!-- Premium locked overlay -->
    <div id="premium-lock" class={isFree ? 'hidden' : 'mt-8 text-center'}>
      <div class="bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/20 rounded-2xl p-12">
        <div class="text-6xl mb-4">ğŸ”’</div>
        <h2 class="text-2xl font-bold mb-3">áƒ”áƒ¡ áƒ’áƒáƒ™áƒ•áƒ”áƒ—áƒ˜áƒšáƒ˜ áƒáƒ áƒ”áƒ›áƒ˜áƒ£áƒ›áƒ˜áƒ</h2>
        <p class="text-[#6B6B65] mb-6 max-w-md mx-auto">áƒ’áƒáƒ®áƒ¡áƒ”áƒœáƒ˜ áƒ§áƒ•áƒ”áƒšáƒ áƒ’áƒ áƒáƒ›áƒáƒ¢áƒ˜áƒ™áƒ˜áƒ¡ áƒ’áƒáƒ™áƒ•áƒ”áƒ—áƒ˜áƒšáƒ˜ áƒáƒ áƒ”áƒ›áƒ˜áƒ£áƒ› áƒ’áƒ”áƒ’áƒ›áƒ˜áƒ—.</p>
        <a href="/premium/" class="inline-block bg-[var(--color-primary)] hover:bg-[var(--color-primary-hover)] text-white font-bold py-3 px-8 rounded-xl text-lg transition-colors">
          ğŸš€ áƒ“áƒáƒ˜áƒ¬áƒ§áƒ” áƒáƒ áƒ”áƒ›áƒ˜áƒ£áƒ›áƒ˜
        </a>
      </div>
    </div>

    <!-- Mark as learned -->
    <div id="mark-section" class={isFree ? 'mt-8 text-center' : 'hidden mt-8 text-center'}>
      <button id="mark-grammar-btn" data-title={lesson.title_en} class="inline-flex items-center gap-2 bg-[#242426] hover:bg-[#2E2E30] border-2 border-[#6B6B65] rounded-xl px-6 py-3 font-semibold transition-colors">
        <span id="mark-grammar-icon">âœ“</span>
        <span id="mark-grammar-text">áƒ›áƒáƒœáƒ˜áƒ¨áƒœáƒ” áƒœáƒáƒ¡áƒ¬áƒáƒ•áƒšáƒáƒ“</span>
      </button>
    </div>
  </section>

  <script is:inline>
    (function() {
      // Unlock premium grammar for premium users
      if (localStorage.getItem('fluentge-premium') === 'true') {
        var lc = document.getElementById('lesson-content');
        if (lc) lc.classList.remove('hidden');
        var pl = document.getElementById('premium-lock');
        if (pl) pl.classList.add('hidden');
        var ms = document.getElementById('mark-section');
        if (ms) ms.classList.remove('hidden');
      }
      const btn = document.getElementById('mark-grammar-btn');
      if (!btn) return;
      const title = btn.dataset.title;
      const stored = JSON.parse(localStorage.getItem('fluentge-learned-grammar') || '[]');
      if (stored.includes(title)) {
        btn.classList.remove('border-[#6B6B65]');
        btn.classList.add('border-green-400', 'text-green-400', 'bg-green-400/10');
        document.getElementById('mark-grammar-text').textContent = 'áƒœáƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ˜áƒ âœ…';
      }
      btn.addEventListener('click', function() {
        const items = JSON.parse(localStorage.getItem('fluentge-learned-grammar') || '[]');
        if (items.includes(title)) {
          items.splice(items.indexOf(title), 1);
          btn.classList.remove('border-green-400', 'text-green-400', 'bg-green-400/10');
          btn.classList.add('border-[#6B6B65]');
          document.getElementById('mark-grammar-text').textContent = 'áƒ›áƒáƒœáƒ˜áƒ¨áƒœáƒ” áƒœáƒáƒ¡áƒ¬áƒáƒ•áƒšáƒáƒ“';
        } else {
          items.push(title);
          btn.classList.add('border-green-400', 'text-green-400', 'bg-green-400/10');
          btn.classList.remove('border-[#6B6B65]');
          document.getElementById('mark-grammar-text').textContent = 'áƒœáƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ˜áƒ âœ…';
        }
        localStorage.setItem('fluentge-learned-grammar', JSON.stringify(items));
      });
    })();
  </script>

  <script define:vars={{ exercises: lesson.exercises, isFree }}>
    // Sound feedback â€” resume AudioContext on first user click (required by browsers)
    let audioCtx = null;
    function getCtx() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume();
      return audioCtx;
    }
    function playCorrectSound() {
      try {
        const ctx = getCtx();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g);
        g.connect(ctx.destination);
        g.gain.setValueAtTime(0.15, ctx.currentTime);
        o.type = 'sine';
        o.frequency.setValueAtTime(523, ctx.currentTime);
        o.frequency.setValueAtTime(659, ctx.currentTime + 0.1);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
        o.start(ctx.currentTime);
        o.stop(ctx.currentTime + 0.35);
      } catch(e) { console.log('sound error', e); }
    }
    function playWrongSound() {
      try {
        const ctx = getCtx();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g);
        g.connect(ctx.destination);
        g.gain.setValueAtTime(0.12, ctx.currentTime);
        o.type = 'sine';
        o.frequency.setValueAtTime(330, ctx.currentTime);
        o.frequency.setValueAtTime(262, ctx.currentTime + 0.15);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25);
        o.start(ctx.currentTime);
        o.stop(ctx.currentTime + 0.3);
      } catch(e) { console.log('sound error', e); }
    }

    if (!isFree) { /* skip exercises for premium lessons */ }
    else {
    let current = 0;
    let score = 0;
    let answered = false;

    const container = document.getElementById('exercise-container');
    const scoreContainer = document.getElementById('score-container');

    function render() {
      if (current >= exercises.length) {
        container.classList.add('hidden');
        scoreContainer.classList.remove('hidden');
        const pct = Math.round((score / exercises.length) * 100);
        document.getElementById('score-text').textContent = `${score}/${exercises.length} (${pct}%)`;
        document.getElementById('score-msg').textContent = pct >= 80 ? 'ğŸ‰ áƒ¨áƒ”áƒ¡áƒáƒœáƒ˜áƒ¨áƒœáƒáƒ•áƒ˜!' : pct >= 50 ? 'ğŸ‘ áƒ™áƒáƒ áƒ’áƒ˜ áƒ¨áƒ”áƒ“áƒ”áƒ’áƒ˜!' : 'ğŸ’ª áƒ™áƒ˜áƒ“áƒ”áƒ• áƒ¡áƒªáƒáƒ“áƒ”!';
        return;
      }
      answered = false;
      const ex = exercises[current];
      const isMulti = ex.type === 'multiple-choice';
      
      let html = `<div class="mb-3 text-xs text-[#6B6B65]">${current + 1}/${exercises.length}</div>`;
      html += `<div class="w-full bg-[#242426] rounded-full h-1.5 mb-6"><div class="bg-[#C8C8C0] h-1.5 rounded-full transition-all" style="width:${((current) / exercises.length) * 100}%"></div></div>`;
      
      if (isMulti) {
        html += `<p class="text-lg font-medium mb-4">${ex.question}</p>`;
      } else {
        html += `<p class="text-lg font-medium mb-4">${ex.question.replace('___', '<span class="text-[#C8C8C0] font-bold">______</span>')}</p>`;
      }
      
      html += `<div class="grid gap-3">`;
      for (const opt of ex.options) {
        html += `<button class="opt-btn text-left px-4 py-3 rounded-lg border border-[#2E2E30] bg-[#242426] hover:bg-[#242426] transition-colors font-medium" data-val="${opt}">${opt}</button>`;
      }
      html += `</div><div id="feedback" class="mt-4"></div>`;
      
      container.innerHTML = html;
      container.querySelectorAll('.opt-btn').forEach(btn => {
        btn.addEventListener('click', () => handleAnswer(btn));
      });
    }

    function handleAnswer(btn) {
      if (answered) return;
      answered = true;
      const val = btn.dataset.val;
      const ex = exercises[current];
      const correct = val === ex.answer;
      if (correct) { score++; playCorrectSound(); } else { playWrongSound(); }

      container.querySelectorAll('.opt-btn').forEach(b => {
        if (b.dataset.val === ex.answer) {
          b.classList.remove('bg-[#242426]', 'border-[#2E2E30]');
          b.classList.add('bg-green-500/20', 'border-green-500', 'text-green-400');
        } else if (b === btn && !correct) {
          b.classList.remove('bg-[#242426]', 'border-[#2E2E30]');
          b.classList.add('bg-red-500/20', 'border-red-500', 'text-red-400');
        }
        b.classList.add('pointer-events-none');
      });

      document.getElementById('feedback').innerHTML = correct
        ? '<p class="text-green-400 font-medium">âœ… áƒ¡áƒ¬áƒáƒ áƒ˜áƒ!</p>'
        : `<p class="text-red-400 font-medium">âŒ áƒáƒ áƒáƒ¡áƒ¬áƒáƒ áƒ˜áƒ. áƒ¡áƒ¬áƒáƒ áƒ˜ áƒáƒáƒ¡áƒ£áƒ®áƒ˜: <strong>${ex.answer}</strong></p>`;

      setTimeout(() => { current++; render(); }, 1500);
    }

    document.getElementById('retry-btn').addEventListener('click', () => {
      current = 0; score = 0;
      scoreContainer.classList.add('hidden');
      container.classList.remove('hidden');
      render();
    });

    render();
    }
  </script>
</Layout>
