---
import Layout from '../layouts/Layout.astro';
import fs from 'fs';
import path from 'path';

const phraseDir = path.resolve('..', 'content', 'phrasebook');
const files = fs.readdirSync(phraseDir).filter(f => f.endsWith('.json')).sort();

const categoryMeta: Record<string, { icon: string; title: string }> = {
  '01-greetings-basics': { icon: 'ğŸ‘‹', title: 'áƒ›áƒ˜áƒ¡áƒáƒšáƒ›áƒ”áƒ‘áƒ áƒ“áƒ áƒ¡áƒáƒ¤áƒ£áƒ«áƒ•áƒšáƒ”áƒ‘áƒ˜' },
  '02-numbers-money': { icon: 'ğŸ’°', title: 'áƒ áƒ˜áƒªáƒ®áƒ•áƒ”áƒ‘áƒ˜ áƒ“áƒ áƒ¤áƒ£áƒšáƒ˜' },
  '03-food-restaurant': { icon: 'ğŸ½ï¸', title: 'áƒ¡áƒáƒ™áƒ•áƒ”áƒ‘áƒ˜ áƒ“áƒ áƒ áƒ”áƒ¡áƒ¢áƒáƒ áƒáƒœáƒ˜' },
  '04-directions-transport': { icon: 'ğŸšŒ', title: 'áƒ›áƒ˜áƒ›áƒáƒ áƒ—áƒ£áƒšáƒ”áƒ‘áƒ áƒ“áƒ áƒ¢áƒ áƒáƒœáƒ¡áƒáƒáƒ áƒ¢áƒ˜' },
  '05-emergency-help': { icon: 'ğŸš¨', title: 'áƒ’áƒáƒ“áƒáƒ£áƒ“áƒ”áƒ‘áƒ”áƒšáƒ˜ áƒ“áƒáƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ' },
  '06-shopping-basics': { icon: 'ğŸ›ï¸', title: 'áƒ›áƒáƒ¦áƒáƒ–áƒ˜áƒáƒ¨áƒ˜' },
  '07-time-dates': { icon: 'ğŸ•', title: 'áƒ“áƒ áƒ áƒ“áƒ áƒ—áƒáƒ áƒ˜áƒ¦áƒ”áƒ‘áƒ˜' },
  '08-family-people': { icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', title: 'áƒáƒ¯áƒáƒ®áƒ˜ áƒ“áƒ áƒáƒ“áƒáƒ›áƒ˜áƒáƒœáƒ”áƒ‘áƒ˜' },
  '09-hotel-accommodation': { icon: 'ğŸ¨', title: 'áƒ¡áƒáƒ¡áƒ¢áƒ£áƒ›áƒ áƒ' },
  '10-phone-internet': { icon: 'ğŸ“±', title: 'áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜ áƒ“áƒ áƒ˜áƒœáƒ¢áƒ”áƒ áƒœáƒ”áƒ¢áƒ˜' },
  '11-weather-nature': { icon: 'ğŸŒ¤ï¸', title: 'áƒáƒ›áƒ˜áƒœáƒ“áƒ˜ áƒ“áƒ áƒ‘áƒ£áƒœáƒ”áƒ‘áƒ' },
  '12-health-doctor': { icon: 'ğŸ©º', title: 'áƒ¯áƒáƒœáƒ›áƒ áƒ—áƒ”áƒšáƒáƒ‘áƒ áƒ“áƒ áƒ”áƒ¥áƒ˜áƒ›áƒ˜' },
  '13-home-apartment': { icon: 'ğŸ ', title: 'áƒ¡áƒáƒ®áƒšáƒ˜ áƒ“áƒ áƒ‘áƒ˜áƒœáƒ' },
  '14-work-office': { icon: 'ğŸ’¼', title: 'áƒ¡áƒáƒ›áƒ¡áƒáƒ®áƒ£áƒ áƒ˜' },
  '15-school-education': { icon: 'ğŸ“', title: 'áƒ¡áƒ™áƒáƒšáƒ áƒ“áƒ áƒ’áƒáƒœáƒáƒ—áƒšáƒ”áƒ‘áƒ' },
  '16-hobbies-free-time': { icon: 'ğŸ¨', title: 'áƒ°áƒáƒ‘áƒ˜ áƒ“áƒ áƒ—áƒáƒ•áƒ˜áƒ¡áƒ£áƒ¤áƒáƒšáƒ˜ áƒ“áƒ áƒ' },
  '17-opinions-agreements': { icon: 'ğŸ’­', title: 'áƒáƒ–áƒ áƒ˜áƒ¡ áƒ’áƒáƒ›áƒáƒ—áƒ¥áƒ›áƒ' },
  '18-emotions-feelings': { icon: 'ğŸ˜Š', title: 'áƒ”áƒ›áƒáƒªáƒ˜áƒ”áƒ‘áƒ˜ áƒ“áƒ áƒ’áƒ áƒ«áƒœáƒáƒ‘áƒ”áƒ‘áƒ˜' },
  '19-relationships-dating': { icon: 'â¤ï¸', title: 'áƒ£áƒ áƒ—áƒ˜áƒ”áƒ áƒ—áƒáƒ‘áƒ”áƒ‘áƒ˜' },
  '20-parties-social': { icon: 'ğŸ‰', title: 'áƒ¬áƒ•áƒ”áƒ£áƒšáƒ”áƒ‘áƒ”áƒ‘áƒ˜ áƒ“áƒ áƒ¡áƒáƒªáƒ˜áƒáƒšáƒ£áƒ áƒ˜' },
  '21-complaints-problems': { icon: 'ğŸ˜¤', title: 'áƒ¡áƒáƒ©áƒ˜áƒ•áƒ áƒ”áƒ‘áƒ˜ áƒ“áƒ áƒáƒ áƒáƒ‘áƒšáƒ”áƒ›áƒ”áƒ‘áƒ˜' },
  '22-plans-future': { icon: 'ğŸ“‹', title: 'áƒ’áƒ”áƒ’áƒ›áƒ”áƒ‘áƒ˜ áƒ“áƒ áƒ›áƒáƒ›áƒáƒ•áƒáƒšáƒ˜' },
  '23-small-talk': { icon: 'ğŸ—£ï¸', title: 'áƒ›áƒªáƒ˜áƒ áƒ” áƒ¡áƒáƒ£áƒ‘áƒáƒ áƒ˜' },
  '24-travel-vacation': { icon: 'âœˆï¸', title: 'áƒ›áƒáƒ’áƒ–áƒáƒ£áƒ áƒáƒ‘áƒ áƒ“áƒ áƒ¨áƒ•áƒ”áƒ‘áƒ£áƒšáƒ”áƒ‘áƒ' },
  '25-business-meetings': { icon: 'ğŸ¤', title: 'áƒ‘áƒ˜áƒ–áƒœáƒ”áƒ¡áƒ˜ áƒ“áƒ áƒ¨áƒ”áƒ®áƒ•áƒ”áƒ“áƒ áƒ”áƒ‘áƒ˜' },
  '26-debates-arguments': { icon: 'âš–ï¸', title: 'áƒ“áƒ”áƒ‘áƒáƒ¢áƒ”áƒ‘áƒ˜ áƒ“áƒ áƒ™áƒáƒ›áƒáƒ—áƒ˜' },
  '27-idioms-expressions': { icon: 'ğŸ¯', title: 'áƒ˜áƒ“áƒ˜áƒáƒ›áƒ”áƒ‘áƒ˜ áƒ“áƒ áƒ’áƒáƒ›áƒáƒ—áƒ¥áƒ›áƒ”áƒ‘áƒ˜' },
  '28-humor-jokes': { icon: 'ğŸ˜‚', title: 'áƒ˜áƒ£áƒ›áƒáƒ áƒ˜ áƒ“áƒ áƒ®áƒ£áƒ›áƒ áƒáƒ‘áƒ”áƒ‘áƒ˜' },
  '29-technology-apps': { icon: 'ğŸ’»', title: 'áƒ¢áƒ”áƒ¥áƒœáƒáƒšáƒáƒ’áƒ˜áƒ áƒ“áƒ áƒáƒáƒšáƒ˜áƒ™áƒáƒªáƒ˜áƒ”áƒ‘áƒ˜' },
  '30-news-politics': { icon: 'ğŸ“°', title: 'áƒáƒ®áƒáƒšáƒ˜ áƒáƒ›áƒ‘áƒ”áƒ‘áƒ˜ áƒ“áƒ áƒáƒáƒšáƒ˜áƒ¢áƒ˜áƒ™áƒ' },
  '31-sports-fitness': { icon: 'ğŸ‹ï¸', title: 'áƒ¡áƒáƒáƒ áƒ¢áƒ˜ áƒ“áƒ áƒ¤áƒ˜áƒ¢áƒœáƒ”áƒ¡áƒ˜' },
  '32-movies-entertainment': { icon: 'ğŸ¬', title: 'áƒ¤áƒ˜áƒšáƒ›áƒ”áƒ‘áƒ˜ áƒ“áƒ áƒ’áƒáƒ áƒ—áƒáƒ‘áƒ' },
  '33-slang-informal': { icon: 'ğŸ”¥', title: 'áƒ¡áƒšáƒ”áƒœáƒ’áƒ˜ áƒ“áƒ áƒáƒ áƒáƒ¤áƒáƒ áƒ›áƒáƒšáƒ£áƒ áƒ˜' },
  '34-professional-formal': { icon: 'ğŸ‘”', title: 'áƒáƒ áƒáƒ¤áƒ”áƒ¡áƒ˜áƒ£áƒšáƒ˜ áƒ“áƒ áƒ¤áƒáƒ áƒ›áƒáƒšáƒ£áƒ áƒ˜' },
  '35-academic-intellectual': { icon: 'ğŸ“š', title: 'áƒáƒ™áƒáƒ“áƒ”áƒ›áƒ˜áƒ£áƒ áƒ˜ áƒ“áƒ áƒ˜áƒœáƒ¢áƒ”áƒšáƒ”áƒ¥áƒ¢áƒ£áƒáƒšáƒ£áƒ áƒ˜' },
  '36-cultural-references': { icon: 'ğŸŒ', title: 'áƒ™áƒ£áƒšáƒ¢áƒ£áƒ áƒ£áƒšáƒ˜ áƒ›áƒ˜áƒ—áƒ˜áƒ—áƒ”áƒ‘áƒ”áƒ‘áƒ˜' },
  '37-sarcasm-irony': { icon: 'ğŸ˜', title: 'áƒ¡áƒáƒ áƒ™áƒáƒ–áƒ›áƒ˜ áƒ“áƒ áƒ˜áƒ áƒáƒœáƒ˜áƒ' },
  '38-proverbs-wisdom': { icon: 'ğŸ¦‰', title: 'áƒáƒœáƒ“áƒáƒ–áƒ”áƒ‘áƒ˜ áƒ“áƒ áƒ¡áƒ˜áƒ‘áƒ áƒ«áƒœáƒ”' },
  '39-negotiation-persuasion': { icon: 'ğŸª', title: 'áƒ›áƒáƒšáƒáƒáƒáƒ áƒáƒ™áƒ”áƒ‘áƒ áƒ“áƒ áƒ“áƒáƒ áƒ¬áƒ›áƒ£áƒœáƒ”áƒ‘áƒ' },
  '40-storytelling-narrative': { icon: 'ğŸ“–', title: 'áƒ›áƒáƒ—áƒ®áƒ áƒáƒ‘áƒ áƒ“áƒ áƒœáƒáƒ áƒáƒ¢áƒ˜áƒ•áƒ˜' },
};

interface Phrase {
  id: string;
  english: string;
  georgian: string;
  literal?: string;
  context?: string;
  level?: string;
  category?: string;
}

interface Category {
  key: string;
  icon: string;
  title: string;
  phrases: Phrase[];
}

const categories: Category[] = files.map(f => {
  const key = f.replace('.json', '');
  const meta = categoryMeta[key] || { icon: 'ğŸ“', title: key };
  const phrases: Phrase[] = JSON.parse(fs.readFileSync(path.join(phraseDir, f), 'utf-8'));
  return { key, ...meta, phrases };
});

const totalPhrases = categories.reduce((sum, c) => sum + c.phrases.length, 0);

const FREE_CATEGORIES = 5;
---

<Layout title="ğŸ’¬ áƒ¤áƒ áƒáƒ–áƒ”áƒ‘áƒ˜ â€” FluentGe">
  <section class="relative overflow-hidden">
    <div class="absolute inset-0">
      <img src="https://images.unsplash.com/photo-1543165796-5426273eaab3?w=1400&q=80" alt="" class="w-full h-full object-cover opacity-30"/>
      <div class="absolute inset-0 bg-gradient-to-b from-[#1C1C1E]/60 to-[#1C1C1E]"></div>
    </div>
    <div class="relative max-w-4xl mx-auto px-4 pt-24 pb-16 text-center">
      <h1 class="font-['Playfair_Display',serif] text-3xl sm:text-4xl md:text-5xl mb-4 leading-tight">áƒ¤áƒ áƒáƒ–áƒ”áƒ‘áƒ˜</h1>
      <p class="text-base sm:text-lg text-[#A0A09A] max-w-xl mx-auto">áƒ§áƒáƒ•áƒ”áƒšáƒ“áƒ¦áƒ˜áƒ£áƒ áƒ˜ áƒ˜áƒœáƒ’áƒšáƒ˜áƒ¡áƒ£áƒ áƒ˜ áƒ¤áƒ áƒáƒ–áƒ”áƒ‘áƒ˜ áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜ áƒ—áƒáƒ áƒ’áƒ›áƒáƒœáƒ˜áƒ— áƒ“áƒ áƒáƒ£áƒ“áƒ˜áƒáƒ—áƒ˜</p>
    </div>
  </section>

  <!-- Search & Stats -->
  <section class="max-w-4xl mx-auto px-4 pt-8">
    <div class="text-center mb-6">
      <p class="text-[#6B6B65] text-sm">{totalPhrases} áƒ¤áƒ áƒáƒ–áƒ Â· {categories.length} áƒ™áƒáƒ¢áƒ”áƒ’áƒáƒ áƒ˜áƒ Â· ğŸ”Š áƒáƒ£áƒ“áƒ˜áƒáƒ—áƒ˜</p>
    </div>
    <div class="mb-8">
      <input type="text" id="searchInput" placeholder="ğŸ” áƒ›áƒáƒ«áƒ”áƒ‘áƒœáƒ” áƒ¤áƒ áƒáƒ–áƒ..." class="w-full bg-[#242426] border border-[#2E2E30] rounded-xl px-4 py-3 text-[#C8C8C0] placeholder-[#6B6B65] focus:outline-none focus:border-[#D4A853]"/>
    </div>

    <!-- Level Filter -->
    <div class="flex gap-2 justify-center mb-8 flex-wrap">
      <button class="level-btn active px-4 py-2 rounded-full text-sm border border-[#2E2E30] bg-[#D4A853] text-black font-medium" data-level="all">áƒ§áƒ•áƒ”áƒšáƒ</button>
      <button class="level-btn px-4 py-2 rounded-full text-sm border border-[#2E2E30] bg-[#242426] text-[#C8C8C0] hover:border-[#D4A853]" data-level="A1">A1</button>
      <button class="level-btn px-4 py-2 rounded-full text-sm border border-[#2E2E30] bg-[#242426] text-[#C8C8C0] hover:border-[#D4A853]" data-level="A2">A2</button>
      <button class="level-btn px-4 py-2 rounded-full text-sm border border-[#2E2E30] bg-[#242426] text-[#C8C8C0] hover:border-[#D4A853]" data-level="B1">B1</button>
      <button class="level-btn px-4 py-2 rounded-full text-sm border border-[#2E2E30] bg-[#242426] text-[#C8C8C0] hover:border-[#D4A853]" data-level="B2">B2</button>
      <button class="level-btn px-4 py-2 rounded-full text-sm border border-[#2E2E30] bg-[#242426] text-[#C8C8C0] hover:border-[#D4A853]" data-level="C1">C1</button>
    </div>
  </section>

  <!-- Categories -->
  <section class="max-w-4xl mx-auto px-4 pb-16">
    <div class="space-y-6" id="categoriesContainer">
      {categories.map((cat, catIdx) => {
        const isPremium = catIdx >= FREE_CATEGORIES;
        return (
        <div class={`category-block bg-[#242426] border border-[#2E2E30] rounded-2xl overflow-hidden ${isPremium ? 'premium-locked' : ''}`} data-cat-index={catIdx} data-premium={isPremium ? 'true' : 'false'}>
          <button class={`w-full p-5 border-b border-[#2E2E30] flex items-center justify-between cursor-pointer hover:bg-[#2A2A2C] transition-colors ${isPremium ? 'premium-toggle' : 'cat-toggle'}`}>
            <div class="flex items-center gap-3">
              <span class="text-2xl">{cat.icon}</span>
              <div class="text-left">
                <h2 class={`text-lg font-bold ${isPremium ? 'text-[#6B6B65]' : 'text-[#C8C8C0]'}`}>{cat.title}</h2>
                <p class="text-xs text-[#6B6B65]">{cat.phrases.length} áƒ¤áƒ áƒáƒ–áƒ</p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              {isPremium ? (
                <span class="flex items-center gap-1 text-xs bg-[#D4A853]/20 text-[#D4A853] px-3 py-1 rounded-full">ğŸ”’ áƒáƒ áƒ”áƒ›áƒ˜áƒ£áƒ›</span>
              ) : (
                <svg class="w-5 h-5 text-[#6B6B65] cat-arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              )}
            </div>
          </button>
          {!isPremium && (
          <div class="phrases-list hidden divide-y divide-white/5">
            {cat.phrases.map((phrase) => (
              <div class="phrase-item px-5 py-4 hover:bg-[#2A2A2C] transition-colors" data-level={phrase.level} data-en={phrase.english.toLowerCase()} data-ka={phrase.georgian.toLowerCase()}>
                <div class="flex items-start gap-3">
                  <button class="play-btn mt-1 w-8 h-8 flex-shrink-0 flex items-center justify-center rounded-full bg-[#D4A853]/20 text-[#D4A853] hover:bg-[#D4A853]/40 transition-colors" data-audio={`/audio/phrases/${phrase.id}.mp3`} title="áƒ›áƒáƒ£áƒ¡áƒ›áƒ˜áƒœáƒ”">
                    ğŸ”Š
                  </button>
                  <div class="flex-1">
                    <div class="flex items-start justify-between gap-2">
                      <div>
                        <p class="text-[#C8C8C0] font-medium text-lg">{phrase.english}</p>
                        <p class="text-[#8B8B85] mt-1">{phrase.georgian}</p>
                      </div>
                      <button class="mark-phrase-btn flex-shrink-0 w-8 h-8 rounded-full border-2 border-[#6B6B65] flex items-center justify-center text-[#6B6B65] hover:border-green-400 hover:text-green-400 transition-colors" data-phrase={phrase.english} title="áƒ›áƒáƒœáƒ˜áƒ¨áƒœáƒ” áƒœáƒáƒ¡áƒ¬áƒáƒ•áƒšáƒáƒ“">
                        âœ“
                      </button>
                    </div>
                    {phrase.literal && <p class="text-xs text-[#5B5B55] mt-1 italic">áƒáƒ˜áƒ áƒ“áƒáƒáƒ˜áƒ áƒ˜: {phrase.literal}</p>}
                    <div class="flex items-center gap-2 mt-2">
                      {phrase.level && <span class={`text-xs px-2 py-0.5 rounded-full ${phrase.level === 'A1' ? 'bg-green-900/30 text-green-400' : phrase.level === 'A2' ? 'bg-blue-900/30 text-blue-400' : phrase.level === 'B1' ? 'bg-yellow-900/30 text-yellow-400' : phrase.level === 'B2' ? 'bg-orange-900/30 text-orange-400' : 'bg-red-900/30 text-red-400'}`}>{phrase.level}</span>}
                      {phrase.context && <span class="text-xs text-[#5B5B55]">ğŸ“Œ {phrase.context}</span>}
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
          )}
        </div>
        );
      })}
    </div>
  </section>

  <!-- Premium Paywall Modal -->
  <div id="premiumModal" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-[#242426] border border-[#2E2E30] rounded-2xl max-w-md w-full p-8 text-center">
      <div class="text-5xl mb-4">ğŸ”’</div>
      <h3 class="text-2xl font-bold text-[#C8C8C0] mb-3">áƒáƒ áƒ”áƒ›áƒ˜áƒ£áƒ› áƒ™áƒáƒœáƒ¢áƒ”áƒœáƒ¢áƒ˜</h3>
      <p class="text-[#8B8B85] mb-2">áƒ”áƒ¡ áƒ™áƒáƒ¢áƒ”áƒ’áƒáƒ áƒ˜áƒ áƒ›áƒ®áƒáƒšáƒáƒ“ áƒáƒ áƒ”áƒ›áƒ˜áƒ£áƒ› áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ”áƒ‘áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡áƒáƒ.</p>
      <p class="text-[#8B8B85] mb-6">áƒ’áƒáƒ®áƒ¡áƒ”áƒœáƒ˜ <strong class="text-[#D4A853]">1,400+ áƒ¤áƒ áƒáƒ–áƒ</strong> 35 áƒ™áƒáƒ¢áƒ”áƒ’áƒáƒ áƒ˜áƒáƒ¨áƒ˜ áƒáƒ£áƒ“áƒ˜áƒáƒ—áƒ˜! áƒ›áƒ®áƒáƒšáƒáƒ“ $9.99!</p>
      <div class="bg-[#1C1C1E] rounded-xl p-4 mb-6">
        <p class="text-[#D4A853] text-2xl font-bold">$9.99</p>
        <p class="text-xs text-[#6B6B65] mt-1">áƒ”áƒ áƒ—áƒ¯áƒ”áƒ áƒáƒ“áƒ˜ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ â€” áƒ¡áƒáƒ›áƒ£áƒ“áƒáƒ›áƒ áƒ¬áƒ•áƒ“áƒáƒ›áƒ</p>
      </div>
      <a href="/premium" class="inline-block w-full bg-[#D4A853] text-black font-bold py-3 px-6 rounded-xl hover:bg-[#C49A48] transition-colors mb-3">áƒ’áƒáƒ®áƒ¡áƒ”áƒœáƒ˜ áƒáƒ áƒ”áƒ›áƒ˜áƒ£áƒ›áƒ˜ âš¡</a>
      <button id="closeModal" class="text-[#6B6B65] text-sm hover:text-[#C8C8C0] transition-colors">áƒ“áƒáƒ®áƒ£áƒ áƒ•áƒ</button>
    </div>
  </div>
</Layout>

<script>
  let currentAudio: HTMLAudioElement | null = null;

  // Play audio
  document.querySelectorAll('.play-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const src = (btn as HTMLElement).dataset.audio;
      if (!src) return;
      if (currentAudio) { currentAudio.pause(); currentAudio = null; }
      currentAudio = new Audio(src);
      currentAudio.play().catch(() => {
        // Fallback to Web Speech API
        const text = btn.closest('.phrase-item')?.querySelector('.text-lg')?.textContent;
        if (text) {
          const u = new SpeechSynthesisUtterance(text);
          u.lang = 'en-US';
          u.rate = 0.85;
          speechSynthesis.speak(u);
        }
      });
    });
  });

  // Toggle free categories
  document.querySelectorAll('.cat-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const block = btn.closest('.category-block');
      const list = block?.querySelector('.phrases-list');
      const arrow = block?.querySelector('.cat-arrow');
      if (list && arrow) {
        list.classList.toggle('hidden');
        arrow.classList.toggle('rotate-180');
      }
    });
  });

  // Unlock premium for premium users
  const isPremiumUser = localStorage.getItem('fluentge-premium') === 'true';
  if (isPremiumUser) {
    document.querySelectorAll('.premium-locked').forEach(el => {
      el.classList.remove('premium-locked');
    });
    document.querySelectorAll('.premium-toggle').forEach(btn => {
      btn.classList.remove('premium-toggle');
      btn.classList.add('cat-toggle');
    });
    // Re-bind cat-toggle for newly unlocked
    document.querySelectorAll('.category-block[data-premium="true"] .cat-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        const block = btn.closest('.category-block');
        const list = block?.querySelector('.phrase-list');
        if (list) list.classList.toggle('hidden');
      });
    });
  }

  // Premium categories â†’ show paywall
  const modal = document.getElementById('premiumModal');
  document.querySelectorAll('.premium-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      modal?.classList.remove('hidden');
    });
  });
  document.getElementById('closeModal')?.addEventListener('click', () => {
    modal?.classList.add('hidden');
  });
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) modal.classList.add('hidden');
  });

  // Search
  const searchInput = document.getElementById('searchInput') as HTMLInputElement;
  searchInput?.addEventListener('input', () => {
    const q = searchInput.value.toLowerCase().trim();
    document.querySelectorAll('.phrase-item').forEach(el => {
      const en = (el as HTMLElement).dataset.en || '';
      const ka = (el as HTMLElement).dataset.ka || '';
      const match = !q || en.includes(q) || ka.includes(q);
      (el as HTMLElement).style.display = match ? '' : 'none';
    });
    // Show categories that have visible phrases
    document.querySelectorAll('.category-block').forEach(block => {
      const list = block.querySelector('.phrases-list');
      if (!list) return;
      const visiblePhrases = list.querySelectorAll('.phrase-item:not([style*="display: none"])');
      (block as HTMLElement).style.display = visiblePhrases.length > 0 || !q ? '' : 'none';
      if (q && visiblePhrases.length > 0) {
        list.classList.remove('hidden');
        block.querySelector('.cat-arrow')?.classList.add('rotate-180');
      }
    });
  });

  // Level filter
  document.querySelectorAll('.level-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.level-btn').forEach(b => {
        b.classList.remove('active', 'bg-[#D4A853]', 'text-black', 'font-medium');
        b.classList.add('bg-[#242426]', 'text-[#C8C8C0]');
      });
      btn.classList.add('active', 'bg-[#D4A853]', 'text-black', 'font-medium');
      btn.classList.remove('bg-[#242426]', 'text-[#C8C8C0]');
      
      const level = (btn as HTMLElement).dataset.level;
      document.querySelectorAll('.phrase-item').forEach(el => {
        const phraseLevel = (el as HTMLElement).dataset.level;
        const match = level === 'all' || phraseLevel === level;
        (el as HTMLElement).style.display = match ? '' : 'none';
      });
      document.querySelectorAll('.category-block').forEach(block => {
        const list = block.querySelector('.phrases-list');
        if (!list) return;
        const visiblePhrases = list.querySelectorAll('.phrase-item:not([style*="display: none"])');
        (block as HTMLElement).style.display = visiblePhrases.length > 0 ? '' : 'none';
      });
    });
  });

  // Mark phrases as learned
  const learned = JSON.parse(localStorage.getItem('fluentge-learned-phrases') || '[]');
  document.querySelectorAll('.mark-phrase-btn').forEach(btn => {
    const phrase = (btn as HTMLElement).dataset.phrase || '';
    if (learned.includes(phrase)) {
      btn.classList.remove('border-[#6B6B65]', 'text-[#6B6B65]');
      btn.classList.add('border-green-400', 'text-green-400', 'bg-green-400/10');
    }
    btn.addEventListener('click', () => {
      const stored = JSON.parse(localStorage.getItem('fluentge-learned-phrases') || '[]');
      if (stored.includes(phrase)) {
        const idx = stored.indexOf(phrase);
        stored.splice(idx, 1);
        btn.classList.remove('border-green-400', 'text-green-400', 'bg-green-400/10');
        btn.classList.add('border-[#6B6B65]', 'text-[#6B6B65]');
      } else {
        stored.push(phrase);
        btn.classList.add('border-green-400', 'text-green-400', 'bg-green-400/10');
        btn.classList.remove('border-[#6B6B65]', 'text-[#6B6B65]');
      }
      localStorage.setItem('fluentge-learned-phrases', JSON.stringify(stored));
    });
  });
</script>
