---
import Layout from '../../layouts/Layout.astro';

// Import all category JSONs to build a deck manifest
const categoryFiles = import.meta.glob('/../../flashcard-app/content/*.json', { eager: true });
---

<Layout title="áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ™áƒáƒ¢áƒ”áƒ’áƒáƒ áƒ˜áƒ”áƒ‘áƒ˜ â€” FluentGe">
  <section class="max-w-2xl mx-auto px-4 py-12">
    <a href="/dashboard/" class="text-[#6B6B65] hover:text-[#C8C8C0] text-sm mb-4 inline-block">â† áƒ“áƒ”áƒ¨áƒ‘áƒáƒ áƒ“áƒ˜</a>
    <h1 class="font-['Playfair_Display',serif] text-2xl font-bold mb-2">ğŸ† áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ™áƒáƒ¢áƒ”áƒ’áƒáƒ áƒ˜áƒ”áƒ‘áƒ˜</h1>
    <p class="text-[#A0A09A] text-sm mb-6">áƒ™áƒáƒ¢áƒ”áƒ’áƒáƒ áƒ˜áƒ”áƒ‘áƒ˜ áƒ¡áƒáƒ“áƒáƒª áƒ§áƒ•áƒ”áƒšáƒ áƒ¡áƒ˜áƒ¢áƒ§áƒ•áƒ áƒ˜áƒ¡áƒ¬áƒáƒ•áƒšáƒ”</p>
    
    <!-- Stats -->
    <div class="bg-[#242426] border border-[#2E2E30] rounded-2xl p-6 mb-8">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-4xl font-bold text-[#5B7F5E]" id="completed-count">0</p>
          <p class="text-sm text-[#6B6B65]">áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ™áƒáƒ¢áƒ”áƒ’áƒáƒ áƒ˜áƒ</p>
        </div>
        <div class="flex items-center gap-3">
          <a href="/dashboard/cards/?clear=1" class="bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 text-red-400 text-xs font-semibold px-3 py-2 rounded-xl transition-colors inline-block cursor-pointer no-underline">ğŸ—‘ï¸ áƒ’áƒáƒ¡áƒ£áƒ¤áƒ—áƒáƒ•áƒ”áƒ‘áƒ</a>
          <div class="text-5xl">ğŸ†</div>
        </div>
      </div>
    </div>

    <!-- Category list -->
    <div id="category-list" class="space-y-3"></div>

    <!-- In progress section -->
    <div id="progress-section" class="mt-8 hidden">
      <h2 class="text-lg font-semibold mb-3 text-[#A0A09A]">ğŸ“Š áƒ›áƒ˜áƒ›áƒ“áƒ˜áƒœáƒáƒ áƒ”</h2>
      <div id="progress-list" class="space-y-3"></div>
    </div>

    <!-- Empty state -->
    <div id="empty-state" class="hidden text-center py-16">
      <p class="text-6xl mb-4">ğŸ“</p>
      <p class="text-[#6B6B65] mb-2">áƒ¯áƒ”áƒ  áƒáƒ  áƒ’áƒáƒ¥áƒ•áƒ¡ áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ™áƒáƒ¢áƒ”áƒ’áƒáƒ áƒ˜áƒ</p>
      <p class="text-[#6B6B65] text-sm mb-4">áƒ˜áƒ¡áƒ¬áƒáƒ•áƒšáƒ” áƒ§áƒ•áƒ”áƒšáƒ áƒ¡áƒ˜áƒ¢áƒ§áƒ•áƒ áƒ™áƒáƒ¢áƒ”áƒ’áƒáƒ áƒ˜áƒáƒ¨áƒ˜ áƒ¡áƒáƒ›áƒ˜áƒ•áƒ” áƒ›áƒ˜áƒ›áƒáƒ áƒ—áƒ£áƒšáƒ”áƒ‘áƒ˜áƒ—</p>
      <a href="/flashcards/" class="inline-block bg-[#5B7F5E] text-white px-6 py-2 rounded-xl text-sm font-semibold hover:bg-[#4a6b4d]">áƒ¤áƒšáƒ”áƒ¨áƒ¥áƒáƒ áƒ“áƒ”áƒ‘áƒ˜áƒ¡ áƒ’áƒ•áƒ”áƒ áƒ“áƒ–áƒ” â†’</a>
    </div>
  </section>

  <script is:inline>
    (function() {
      // Clear data if ?clear=1
      if (window.location.search.indexOf('clear=1') > -1) {
        // Clear all card progress
        localStorage.removeItem('knownCards');
        // Clear all fluentge-card-progress
        var keys = Object.keys(localStorage);
        keys.forEach(function(k) {
          if (k.indexOf('fluentge-card-progress') > -1 || k.indexOf('fluentge-srs-') > -1 || k.indexOf('fluentge-session-') > -1) {
            localStorage.removeItem(k);
          }
        });
        window.location.href = '/dashboard/cards/';
        return;
      }

      // Load card progress from localStorage
      var progressData = {};
      try {
        progressData = JSON.parse(localStorage.getItem('fluentge-card-progress') || '{}');
      } catch(e) {}

      // Deck definitions â€” we need category, name, icon, card count
      // This is injected from build
      var decks = [
        { id: 'greetings-basics', name: 'áƒ›áƒ˜áƒ¡áƒáƒšáƒ›áƒ”áƒ‘áƒ', icon: 'ğŸ‘‹' },
        { id: 'family-people', name: 'áƒáƒ¯áƒáƒ®áƒ˜', icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§' },
        { id: 'food-drink', name: 'áƒ¡áƒáƒ­áƒ›áƒ”áƒšáƒ˜', icon: 'ğŸ½ï¸' },
        { id: 'colors-shapes', name: 'áƒ¤áƒ”áƒ áƒ”áƒ‘áƒ˜', icon: 'ğŸ¨' },
        { id: 'numbers-time', name: 'áƒ áƒ˜áƒªáƒ®áƒ•áƒ”áƒ‘áƒ˜', icon: 'ğŸ”¢' },
        { id: 'animals', name: 'áƒªáƒ®áƒáƒ•áƒ”áƒšáƒ”áƒ‘áƒ˜', icon: 'ğŸ¾' },
        { id: 'body-parts', name: 'áƒ¡áƒ®áƒ”áƒ£áƒšáƒ˜áƒ¡ áƒœáƒáƒ¬áƒ˜áƒšáƒ”áƒ‘áƒ˜', icon: 'ğŸ¦´' },
        { id: 'clothes-fashion', name: 'áƒ¢áƒáƒœáƒ¡áƒáƒªáƒ›áƒ”áƒšáƒ˜', icon: 'ğŸ‘—' },
        { id: 'home-housing', name: 'áƒ¡áƒáƒ®áƒšáƒ˜', icon: 'ğŸ ' },
        { id: 'weather-seasons', name: 'áƒáƒ›áƒ˜áƒœáƒ“áƒ˜', icon: 'ğŸŒ¤ï¸' },
        { id: 'travel-transport', name: 'áƒ›áƒáƒ’áƒ–áƒáƒ£áƒ áƒáƒ‘áƒ', icon: 'âœˆï¸' },
        { id: 'health-body', name: 'áƒ¯áƒáƒœáƒ›áƒ áƒ—áƒ”áƒšáƒáƒ‘áƒ', icon: 'ğŸ¥' },
        { id: 'work-business', name: 'áƒ¡áƒáƒ›áƒ¡áƒáƒ®áƒ£áƒ áƒ˜', icon: 'ğŸ’¼' },
        { id: 'education', name: 'áƒ’áƒáƒœáƒáƒ—áƒšáƒ”áƒ‘áƒ', icon: 'ğŸ“š' },
        { id: 'entertainment', name: 'áƒ’áƒáƒ áƒ—áƒáƒ‘áƒ', icon: 'ğŸ¬' },
        { id: 'nature-weather', name: 'áƒ‘áƒ£áƒœáƒ”áƒ‘áƒ', icon: 'ğŸŒ¿' },
        { id: 'sports-fitness', name: 'áƒ¡áƒáƒáƒ áƒ¢áƒ˜', icon: 'âš½' },
        { id: 'technology', name: 'áƒ¢áƒ”áƒ¥áƒœáƒáƒšáƒáƒ’áƒ˜áƒ', icon: 'ğŸ’»' },
        { id: 'emotions-personality', name: 'áƒ”áƒ›áƒáƒªáƒ˜áƒ”áƒ‘áƒ˜', icon: 'ğŸ˜Š' },
        { id: 'shopping-money', name: 'áƒ¨áƒáƒáƒ˜áƒœáƒ’áƒ˜', icon: 'ğŸ›ï¸' },
        { id: 'jobs-professions', name: 'áƒáƒ áƒáƒ¤áƒ”áƒ¡áƒ˜áƒ”áƒ‘áƒ˜', icon: 'ğŸ‘¨â€âš•ï¸' },
        { id: 'music-arts', name: 'áƒ›áƒ£áƒ¡áƒ˜áƒ™áƒ', icon: 'ğŸµ' },
        { id: 'social-media', name: 'áƒ¡áƒáƒªáƒ˜áƒáƒšáƒ£áƒ áƒ˜ áƒ›áƒ”áƒ“áƒ˜áƒ', icon: 'ğŸ“±' },
        { id: 'movies-tv', name: 'áƒ¤áƒ˜áƒšáƒ›áƒ”áƒ‘áƒ˜', icon: 'ğŸ¬' },
        { id: 'sports-games', name: 'áƒ—áƒáƒ›áƒáƒ¨áƒ”áƒ‘áƒ˜', icon: 'ğŸ®' },
        { id: 'restaurant-cafe', name: 'áƒ áƒ”áƒ¡áƒ¢áƒáƒ áƒáƒœáƒ˜', icon: 'â˜•' },
        { id: 'hotel-accommodation', name: 'áƒ¡áƒáƒ¡áƒ¢áƒ£áƒ›áƒ áƒ', icon: 'ğŸ¨' },
        { id: 'doctor-medical', name: 'áƒ”áƒ¥áƒ˜áƒ›áƒ˜', icon: 'ğŸ‘¨â€âš•ï¸' },
        { id: 'airport-flying', name: 'áƒáƒ”áƒ áƒáƒáƒáƒ áƒ¢áƒ˜', icon: 'âœˆï¸' },
        { id: 'banking-finance', name: 'áƒ‘áƒáƒœáƒ™áƒ˜', icon: 'ğŸ¦' },
        { id: 'relationships-dating', name: 'áƒ£áƒ áƒ—áƒ˜áƒ”áƒ áƒ—áƒáƒ‘áƒ”áƒ‘áƒ˜', icon: 'â¤ï¸' },
        { id: 'academic-english', name: 'áƒáƒ™áƒáƒ“áƒ”áƒ›áƒ˜áƒ£áƒ áƒ˜', icon: 'ğŸ†' },
        { id: 'law-crime', name: 'áƒ¡áƒáƒ›áƒáƒ áƒ—áƒáƒšáƒ˜', icon: 'âš–ï¸' },
        { id: 'politics-society', name: 'áƒáƒáƒšáƒ˜áƒ¢áƒ˜áƒ™áƒ', icon: 'ğŸ›ï¸' },
        { id: 'science-math', name: 'áƒ›áƒ”áƒªáƒœáƒ˜áƒ”áƒ áƒ”áƒ‘áƒ', icon: 'ğŸ”¬' },
        { id: 'geography-countries', name: 'áƒ’áƒ”áƒáƒ’áƒ áƒáƒ¤áƒ˜áƒ', icon: 'ğŸŒ' },
        { id: 'religion-culture', name: 'áƒ™áƒ£áƒšáƒ¢áƒ£áƒ áƒ', icon: 'â›ª' },
        { id: 'history-war', name: 'áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ', icon: 'âš”ï¸' },
        { id: 'immigration-visa', name: 'áƒ˜áƒ›áƒ˜áƒ’áƒ áƒáƒªáƒ˜áƒ', icon: 'ğŸ›‚' },
        { id: 'verbs-common', name: 'áƒ–áƒ›áƒœáƒ”áƒ‘áƒ˜', icon: 'ğŸƒ' },
        { id: 'adjectives-common', name: 'áƒ–áƒ”áƒ“áƒ¡áƒáƒ áƒ—áƒáƒ•áƒ”áƒ‘áƒ˜', icon: 'âœ¨' },
        { id: 'slang-informal', name: 'áƒ¡áƒšáƒ”áƒœáƒ’áƒ˜', icon: 'ğŸ—£ï¸' },
        { id: 'modern-slang-2026', name: 'áƒ¡áƒšáƒ”áƒœáƒ’áƒ˜ 2026', icon: 'ğŸ”¥' },
        { id: 'mma-fighting', name: 'MMA', icon: 'ğŸ¥Š' },
        { id: 'gym-fitness', name: 'áƒ¡áƒáƒáƒ áƒ¢ áƒ“áƒáƒ áƒ‘áƒáƒ–áƒ˜', icon: 'ğŸ’ª' },
        { id: 'gaming-esports', name: 'áƒ’áƒ”áƒ˜áƒ›áƒ˜áƒœáƒ’áƒ˜', icon: 'ğŸ®' },
        { id: 'crypto-investing', name: 'áƒ™áƒ áƒ˜áƒáƒ¢áƒ', icon: 'â‚¿' },
        { id: 'startup-business', name: 'áƒ¡áƒ¢áƒáƒ áƒ¢áƒáƒáƒ˜', icon: 'ğŸš€' },
        { id: 'programming-coding', name: 'áƒáƒ áƒáƒ’áƒ áƒáƒ›áƒ˜áƒ áƒ”áƒ‘áƒ', icon: 'ğŸ‘¨â€ğŸ’»' },
        { id: 'dating-romance', name: 'áƒ¨áƒ”áƒ®áƒ•áƒ”áƒ“áƒ áƒ”áƒ‘áƒ˜', icon: 'ğŸ’•' },
        { id: 'car-driving', name: 'áƒ›áƒáƒœáƒ¥áƒáƒœáƒ', icon: 'ğŸš—' },
        { id: 'public-transport', name: 'áƒ¢áƒ áƒáƒœáƒ¡áƒáƒáƒ áƒ¢áƒ˜', icon: 'ğŸšŒ' },
        { id: 'cooking-kitchen', name: 'áƒ¡áƒáƒ›áƒ–áƒáƒ áƒ”áƒ£áƒšáƒ', icon: 'ğŸ‘¨â€ğŸ³' },
        { id: 'gardening-plants', name: 'áƒ‘áƒáƒ¦áƒ˜', icon: 'ğŸŒ±' },
        { id: 'ocean-marine', name: 'áƒáƒ™áƒ”áƒáƒœáƒ”', icon: 'ğŸŒŠ' },
        { id: 'emergency-safety', name: 'áƒ¡áƒáƒ’áƒáƒœáƒ’áƒ”áƒ‘áƒ', icon: 'ğŸš¨' },
        { id: 'household-chores', name: 'áƒ¡áƒáƒ§áƒáƒ¤áƒáƒªáƒ®áƒáƒ•áƒ áƒ”áƒ‘áƒ', icon: 'ğŸ§¹' },
        { id: 'top-2000', name: 'áƒ¢áƒáƒ 2000', icon: 'â­' },
      ];

      // For each deck, check if all 3 directions are completed
      // A card is "learned" in a direction if repetitions >= 1
      function checkDeckCompletion(deckId) {
        var suffixes = ['enka', 'kaen', 'mixed'];
        var results = {};
        
        // Count cards per direction
        var allKeys = Object.keys(progressData);
        var deckPrefix = deckId + '_';
        
        suffixes.forEach(function(suf) {
          var learned = 0;
          var total = 0;
          allKeys.forEach(function(key) {
            // Match keys like "deckId_word_suffix"
            if (key.endsWith('_' + suf)) {
              var base = key.slice(0, -(suf.length + 1));
              if (base.indexOf(deckPrefix) === 0 || progressData[key].category === deckId) {
                total++;
                if (progressData[key] && progressData[key].repetitions >= 1) {
                  learned++;
                }
              }
            }
          });
          results[suf] = { learned: learned, total: total };
        });
        
        return results;
      }

      // Also check cards by category field in progress
      function getCardsByCategory(deckId) {
        var count = 0;
        var keys = Object.keys(progressData);
        // Cards matching this deck pattern (without direction suffix)
        var seen = {};
        keys.forEach(function(key) {
          // Strip direction suffix to get base card
          var base = key.replace(/_enka$/, '').replace(/_kaen$/, '').replace(/_mixed$/, '');
          if (base.indexOf(deckId + '_') === 0 && !seen[base]) {
            seen[base] = true;
            count++;
          }
        });
        return count;
      }

      function getDirProgress(deckId, suffix) {
        var count = 0;
        var keys = Object.keys(progressData);
        keys.forEach(function(key) {
          if (key.endsWith('_' + suffix) && key.indexOf(deckId + '_') === 0) {
            var p = progressData[key];
            if (p && p.repetitions >= 1) count++;
          }
        });
        return count;
      }

      var completedList = document.getElementById('category-list');
      var progressSection = document.getElementById('progress-section');
      var progressList = document.getElementById('progress-list');
      var emptyState = document.getElementById('empty-state');
      var completedCount = 0;
      var inProgressItems = [];

      decks.forEach(function(deck) {
        var totalCards = getCardsByCategory(deck.id);
        if (totalCards === 0) return; // No progress at all

        var enka = getDirProgress(deck.id, 'enka');
        var kaen = getDirProgress(deck.id, 'kaen');
        var mixed = getDirProgress(deck.id, 'mixed');
        var minLearned = Math.min(enka, kaen, mixed);
        var isComplete = totalCards > 0 && minLearned >= totalCards;

        if (isComplete) {
          completedCount++;
          var div = document.createElement('div');
          div.className = 'flex items-center gap-4 bg-[#1a2e1a] border border-[#5B7F5E]/30 rounded-2xl px-5 py-4';
          div.innerHTML = '<span class="text-3xl">' + deck.icon + '</span>' +
            '<div class="flex-1"><p class="font-semibold text-[#C8C8C0]">' + deck.name + '</p>' +
            '<p class="text-xs text-[#5B7F5E]">' + totalCards + ' áƒ¡áƒ˜áƒ¢áƒ§áƒ•áƒ Â· áƒ¡áƒáƒ›áƒ˜áƒ•áƒ” áƒ›áƒ˜áƒ›áƒáƒ áƒ—áƒ£áƒšáƒ”áƒ‘áƒ âœ…</p></div>' +
            '<span class="text-2xl">ğŸ†</span>';
          completedList.appendChild(div);
        } else if (enka > 0 || kaen > 0 || mixed > 0) {
          // In progress
          var avgPct = totalCards > 0 ? Math.round(((enka + kaen + mixed) / (totalCards * 3)) * 100) : 0;
          inProgressItems.push({
            deck: deck,
            total: totalCards,
            enka: enka,
            kaen: kaen,
            mixed: mixed,
            avgPct: avgPct
          });
        }
      });

      document.getElementById('completed-count').textContent = completedCount;

      if (completedCount === 0 && inProgressItems.length === 0) {
        emptyState.classList.remove('hidden');
      }

      // Show in-progress categories
      if (inProgressItems.length > 0) {
        progressSection.classList.remove('hidden');
        inProgressItems.sort(function(a, b) { return b.avgPct - a.avgPct; });
        inProgressItems.forEach(function(item) {
          var div = document.createElement('div');
          div.className = 'bg-[#242426] border border-[#2E2E30] rounded-2xl px-5 py-4';
          var enPct = item.total > 0 ? Math.round((item.enka / item.total) * 100) : 0;
          var kaPct = item.total > 0 ? Math.round((item.kaen / item.total) * 100) : 0;
          var mixPct = item.total > 0 ? Math.round((item.mixed / item.total) * 100) : 0;
          div.innerHTML = '<div class="flex items-center gap-3 mb-3">' +
            '<span class="text-2xl">' + item.deck.icon + '</span>' +
            '<p class="font-semibold text-[#C8C8C0] flex-1">' + item.deck.name + '</p>' +
            '<span class="text-xs text-[#6B6B65]">' + item.avgPct + '%</span></div>' +
            '<div class="space-y-1.5">' +
            '<div class="flex items-center gap-2"><span class="text-[10px] text-[#6B6B65] w-16">ENâ†’KA</span><div class="flex-1 h-1.5 bg-[#1C1C1E] rounded-full overflow-hidden"><div class="h-full bg-[#5B7F5E] rounded-full" style="width:' + enPct + '%"></div></div><span class="text-[10px] text-[#6B6B65]">' + enPct + '%</span></div>' +
            '<div class="flex items-center gap-2"><span class="text-[10px] text-[#6B6B65] w-16">KAâ†’EN</span><div class="flex-1 h-1.5 bg-[#1C1C1E] rounded-full overflow-hidden"><div class="h-full bg-blue-500 rounded-full" style="width:' + kaPct + '%"></div></div><span class="text-[10px] text-[#6B6B65]">' + kaPct + '%</span></div>' +
            '<div class="flex items-center gap-2"><span class="text-[10px] text-[#6B6B65] w-16">áƒ¨áƒ”áƒ áƒ”áƒ£áƒšáƒ˜</span><div class="flex-1 h-1.5 bg-[#1C1C1E] rounded-full overflow-hidden"><div class="h-full bg-purple-500 rounded-full" style="width:' + mixPct + '%"></div></div><span class="text-[10px] text-[#6B6B65]">' + mixPct + '%</span></div>' +
            '</div>';
          progressList.appendChild(div);
        });
      }
    })();
  </script>
</Layout>
